<!DOCTYPE html>
<html lang="en">
  <head>
    {% include 'common_head.html' %}
  </head>
  <body>
    <div class="container">
      <div class="header">
        {% with activeSite='stats' %}
        {% include 'common_title.html' %}
        {% endwith %}
      </div>

      <div class="jumbotron">
        <h1>Some statistics</h1>
        {% include 'common_alerts.html' %}
        <h5> Quick jump to: </h5>
        <li><a href='#statistics'> Users and statistics</a></li>
        <li><a href='#badgeshistory'>Badges Grant History</a></li>
        <li><a href='#debtTransfer'>Debt Transfers History</a></li>
        <li><a href='#Achievements'>Badges and Achievements</a></li>
        <li><a href='#products'>Products Descriton</a></li>
        <hr class="my-3">
        {% include 'game_desc.html' %}
      </div>


      <div class="container">
        <hr class="my-3">
            <div>
              <h2 id='statistics'>Users and statistics: </h2>
              {% include 'totop.html' %}
              <p>
                <li>All statistics caluclated exluding self->self serving unless specified otherwise. </li>
                <li>* Value WITH THE badge modificators, raw is offered - consumed</li>
                <li>** Coffee offered withing # servings</li>
                <li>*** Value without selfbuyings (Total: including selfbuyings)</li>
              </p>
            </div>
            <script>
            $(document).ready(function() {
                $('#dtBasicExample').DataTable({
                  "searching": false,
                  "pageLength": 20,
                  "scrollX": false,
                  "order": [[ 4, "desc" ]] // false to disable search (or any other option)
                  });
            } );
            </script>
            <!-- table table-striped table-hover table-sm -->
            <div class="table-responsive table-borderless">
                <table id="dtBasicExample" class="table table-striped table-sm" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th scope="col">name</th>
                            <th scope="col" class="text-right">actual<br>score*</th>
                            <th scope="col" class="text-right">raw score  </th>
                            <th scope="col" class="text-right">#offered<br>**</th>
                            <th scope="col" class="text-right">#servings</th>
                            <th scope="col" class="text-right">#avg<br>/serving</th>
                            <th scope="col" class="text-right">#consumed<br>***</th>
                            <th scope="col" class="text-right">#total <br>consumed</th>
                            <!-- {% if loggedUsernameEmail['email'] in adminsList['admin'].keys() or loggedUsernameEmail['email'] in adminsList['badgeadmin'].keys() %} -->
                            <th scope="col" class="text-center">  <p> Action {% include 'visible_badges.html' %} </p> </th>
                            <!-- {% endif%} -->
                        </tr>
                    </thead>
                    <tbody>
                    {% for user in users.values() %}
                        {% if not user['active'] %} <tr class="table-dark text-muted">
                        {% else %} <tr >{% endif %}
                            <th class="text-left">
                              <badge title="{{ user['email'] }}">   {{ user['username'] }}
                              {% if loggedUsernameEmail['email'] in adminsList['admin'].keys() %}
                              <a class="btn btn-outline-dark btn-sm" href='/user?user={{user['id']}}'> <img src="static/search.png" width="15" height="15" title="NOT VALIDATED!"/> </a>
                              {%endif%} {%if user['validated'] == 0 %}
                              <img src="static/exclamation-alert.png" width="25" height="25" title="NOT VALIDATED!"/> {% endif %}
                              {%for badge in assignedBadges.values() %} {%if  badge['userId'] == user['id'] %}
                                  <img src="{{ badge['img'] }}" width="25" height="25" title="{{ badge['name'] }}({{ badge['date'] }}, effect: {{badge['effect']}})"/>
                                {% endif %} {% endfor %}
                            </badge>
                          </th>
                            <td class="text-right"> <b>{{'%d'| format(user['rating']|float)}}</b>  </td>
                            <td class="text-right">{{ usersStats.get(user['username'], {False:0}).get('offered', 0) - usersStats.get(user['username'], {False:0}).get('consumed', 0) }}</td>
                            <td class="text-right"> {{ usersStats.get(user['username'], {False:0}).get('offered', 0) }} </td>
                            <td class="text-right">{{ usersStats.get(user['username'], {False:0}).get('served', 0) }}</td>
                            <td class="text-right">
                              {% if usersStats.get(user['username'], {False:0}).get('offered', 0) > 0 %}
                               {{ '%.1f'|format(usersStats.get(user['username'], {False:0}).get('offered', 0) / usersStats.get(user['username'], {False:0}).get('served', 0) ) }}
                              {% else %} 0 {% endif %}
                            </td>
                            <td class="text-right">{{ usersStats.get(user['username'], {False:0}).get('consumed', 0) }} </td>
                            <td class="text-right">{{ usersStats.get(user['username'], {False:0}).get('consumed', 0) + usersStats.get(user['username'], {False:0}).get('served', 0) }}</td>
                            <td class="text-center">
                            {% if loggedUsernameEmail['email'] in adminsList['admin'].keys() or loggedUsernameEmail['email'] in adminsList['badgeadmin'].keys() %}
                            {% if user['active'] == 0 %}
                              <a href="modifyUser?userId={{user['id']}}&active=1"> <img src="static/refresh.png"  width="25" height="25" /> </a>
                            {% else %}
                              <a href="modifyUser?userId={{user['id']}}&active=0"> <img src="static/lock.png"  width="25" height="25" /> </a>
                            {% endif %}
                            {% endif %}
                            {% if user['rating'] < 0  %}
                            <a href="transferDebt?fromUserId={{user['id']}}&toUserId={{loggedUsernameEmail['id']}}"> <img src="static/debt-collector.png"  width="25" height="25" /> </a>
                            {% endif %}
                          </td>
                        </tr>{% endfor %}
                    </tbody>
                </table>
            </div>
            <div id='plots'>
            {% include 'pie-charts.html' %}
            {%with singleUser=False%}
            {% include 'points-evolution.html' %}
            {%endwith%}
          </div>
      </div>

      <div id='badgeshistory' class="container">
        <hr class="my-3">
           <h2> Badges Grant History </h2>
           {% include 'totop.html' %}
           <div class="table-responsive table-borderless">
               <table class="table table-striped table-hover table-sm">
                   <thead>
                       <tr>
                           <th scope="col">Date (granted by) </th>
                           <th scope="col">To Whom </th>
                           <th scope="col">Badge</th>
                           {% if loggedUsernameEmail['email'] in adminsList['admin'].keys() or loggedUsernameEmail['email'] in adminsList['badgeadmin'].keys() %}
                           <th scope="col">  <p> {% include 'visible_badges.html' %} </p> </th>
                           {% endif%}
                       </tr>
                   </thead>
                   <tbody>
                   {% for lastEntry in grantedBadges.values() %}
                      {% if not lastEntry['valid'] %}
                       <tr class="table-dark text-muted">
                      {% else %}
                       <tr >
                      {% endif %}
                           <th scope="row"> <small>{{ lastEntry['date'] }}</small> <span class="text-muted">(by {{ lastEntry['grantByUserName'] }})</span> </th>
                           <td> {{ lastEntry['username'] }} </td>
                           <td> <img src="{{ lastEntry['img'] }}" width="25" height="25" /><span class="text">{{ lastEntry['badgeName'] }} </span> </td>
                           {% if (loggedUsernameEmail['email'] in adminsList['admin'].keys() or loggedUsernameEmail['email'] in adminsList['badgeadmin'].keys() ) and lastEntry['badgeId'] != 7 %}
                            <td class="text-center">
                              {% if lastEntry['valid'] %}
                                <a href="modifyBadge?grantId={{lastEntry['grantId']}}&valid=0"> <img src="static/delete.jpg"  width="25" height="25" /> </a>
                              {% else %}
                                <a href="modifyBadge?grantId={{lastEntry['grantId']}}&valid=1"> <img src="static/refresh.png"  width="25" height="25" /> </a>
                              {% endif %}
                             </td>
                           {% endif %}
                       </tr>
                   {% endfor %}
                   </tbody>
               </table>
           </div>
       </div>


       <div id='debtTransfer' class="container">
         <hr class="my-3">
            <h2> Debt Transfer History </h2>
            {% include 'totop.html' %}
            <div class="table-responsive table-borderless">
                <table class="table table-striped table-hover table-sm">
                    <thead>
                        <tr>
                            <th scope="col">Date</th>
                            <th scope="col">From</th>
                            <th scope="col">To Whom</th>
                            <th scope="col">Value</th>

                        </tr>
                    </thead>
                    <tbody>
                    {% for lastEntry in transferHistory.values() %}
                       {% if not lastEntry['valid'] %}
                        <tr class="table-dark text-muted">
                       {% else %}
                        <tr >
                       {% endif %}
                            <th scope="row"> <small>{{ lastEntry['date'] }}</small> </th>
                            <td> <img src="static/debt-relief.png" width="25" height="25" />{{ lastEntry['fromUserName'] }} </td>
                            <td> <img src="static/debt-collector.png" width="25" height="25" /><span class="text">{{ lastEntry['toUserName'] }} </span> </td>
                            <td> <span class="badge badge-{%if lastEntry['value'] >= 0%}success{%else%}danger{%endif%}">{{ lastEntry['value'] }} </span> </td>
                            {% if (loggedUsernameEmail['email'] in adminsList['admin'].keys() or loggedUsernameEmail['email'] in adminsList['badgeadmin'].keys() ) and lastEntry['badgeId'] != 7 %}
                             <td class="text-center">
                               {% if lastEntry['valid'] %}
                                 <a href="modifyTransfer?transferId={{lastEntry['transferId']}}&valid=0"> <img src="static/delete.jpg"  width="25" height="25" /> </a>
                               {% else %}
                                 <a href="modifyTransfer?transferId={{lastEntry['transferId']}}&valid=1"> <img src="static/refresh.png"  width="25" height="25" /> </a>
                               {% endif %}
                              </td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>


       <div class="container">
         <hr class="my-3">
            <div>
            <h2 id='Achievements'> Badges and Achievements</h2>
            {% include 'totop.html' %}
              <p class="text-default">Badges awarded by the system after each scoring updade, trigered after each registered job.</p>
              <p class="text-primary"> Badges that can be awarded by the SytemAdmin or BadgeAdmin</p>
            </div>
            <div class="table-responsive table-borderless">
                <table class="table table-striped table-hover table-sm">
                    <thead>
                        <tr>
                            <th scope="col">Name</th>
                            <th scope="col">Badge</th>
                            <th scope="col">Description</th>
                            <th scope="col" class="text-right">Effect</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for lastEntry in allBadges.values() %}
                      {% if lastEntry['adminawarded'] == 1 %}
                        <tr class="table-default text-primary">
                      {% else %}
                        <tr >
                      {% endif %}
                            <th scope="row">{{ lastEntry['name'] }}</th>
                            <td> <img src="{{ lastEntry['img'] }}" width="25" height="25" /> </td>
                            <td> {{ lastEntry['desc'] }} </td>
                            <td class="text-right"> <span class="badge badge-{%if lastEntry['effect'] > 0%}success{%elif lastEntry['effect']==0 %}secondary{%else%}danger{%endif%}">{{ lastEntry['effect'] }} </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id='products' class="container">
          <hr class="my-3">
           <h2>Products: </h2>
           {% include 'totop.html' %}
           <div class="table-responsive">
               <table class="table table-striped table-hover table-sm">
                   <thead>
                       <tr>
                           <th scope="col">Name</th>
                           <th scope="col">Price [CHF] </th>
                           <th scope="col">Size [ml] </th>
                           <th scope="col">Caffeine [mg] </th>
                       </tr>
                   </thead>
                   <tbody>
                   {% for id in products %}
                       <tr >
                           <th scope="row"> {{ products[id]['name'] }} </th>
                           <td> {{'%0.1f'| format(products[id]['price']|float)}}</td>
                           <td> {{'%0.1f'| format(products[id]['size']|float)}}</td>
                           <td> {{'%0.1f'| format(products[id]['caffeine']|float)}}</td>
                       </tr>
                   {% endfor %}
                   </tbody>
               </table>
           </div>
         </div>
         {% include 'bar-chart.html' %}

      <footer class="footer">
      {% include 'footer.html' %}
      </footer>

    </div>
  </body>
</html>
